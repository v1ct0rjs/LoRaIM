<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>LoRa Bridge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
  <div class="chat-container">
    <header class="chat-header"><h1>LoRa Bridge</h1></header>
    <main id="messagesContainer" class="messages-container"></main>
    <footer class="chat-footer">
      <form id="sendForm" class="send-form">
        <input type="text" id="messageInput" placeholder="Escribe un mensaje..." autocomplete="off" required>
        <button type="submit" aria-label="Enviar">
          <i data-feather="send"></i>
        </button>
      </form>
    </footer>
  </div>

  <script>
    const msContainer = document.getElementById('messagesContainer');
    const input = document.getElementById('messageInput');
    const form = document.getElementById('sendForm');

    function scrollToBottom(){
      msContainer.scrollTop = msContainer.scrollHeight;
    }

    async function loadMessages(){
      const res = await fetch('/messages?limit=50');
      const { messages } = await res.json();
      msContainer.innerHTML = '';
      messages.forEach(m => {
        const el = document.createElement('div');
        el.classList.add('message');
        const text = typeof m.payload === 'object'
          ? (m.payload.raw ?? JSON.stringify(m.payload))
          : m.payload;
        el.textContent = text;
        el.classList.add(m.source === 'sent' ? 'sent' : 'received');
        msContainer.appendChild(el);
      });
      scrollToBottom();
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const msg = input.value.trim(); if (!msg) return;
      form.querySelector('button').disabled = true;
      await fetch('/publish', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      });
      input.value = '';
      form.querySelector('button').disabled = false;
      await loadMessages();
    });

    feather.replace();
    loadMessages();
    setInterval(loadMessages, 3000);
  </script>

<script>
    const ws = new WebSocket("ws://localhost:8000/ws");

    ws.onmessage = function(event) {
        const msg = JSON.parse(event.data);
        const box = document.getElementById("messages");
        const p = document.createElement("p");
        p.textContent = `[${msg.source}] ${JSON.stringify(msg.payload)}`;
        box.appendChild(p);
        box.scrollTop = box.scrollHeight;
    };

    ws.onopen = function() {
        console.log("WebSocket conectado");
    };

    ws.onerror = function(err) {
        console.error("WebSocket error:", err);
    };
</script>

</body>
</html>