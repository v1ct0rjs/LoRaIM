<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>LoRaIM</title>

  <!-- Fuente Inter + hoja de estilos -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

  <!-- Tarjeta del chat -->
  <div class="chat-container">
    <header class="chat-header">
      LoRa Instant Messenger
      <span id="unread" class="badge hidden">0</span>
    </header>

    <!-- Mensajes -->
    <main id="msgs" class="messages-container"></main>

    <!-- Formulario de envío -->
    <footer class="chat-footer">
      <form id="sendForm" class="send-form" autocomplete="off">
        <input id="msgInput" type="text" placeholder="Escribe un mensaje…" required>
        <button type="submit">➤</button>
      </form>
    </footer>
  </div>

<!-- JavaScript: todo dentro de DOMContentLoaded -->
<script>
window.addEventListener('DOMContentLoaded',()=>{

  /* CONSTANTES ------------------------------------------------ */
  const LOCAL_SOURCE = 'sent';     // así marca el backend nuestros propios envíos
  const wsUrl = (location.protocol==='https:'?'wss://':'ws://')+
                location.hostname+':8000/ws';
  const ws = new WebSocket(wsUrl); // conexión WebSocket al backend FastAPI

  /* ELEMENTOS DEL DOM ----------------------------------------- */
  const msgsEl  = document.getElementById('msgs');      // contenedor mensajes
  const badgeEl = document.getElementById('unread');    // contador no-leídos
  const formEl  = document.getElementById('sendForm');  // formulario
  const inputEl = document.getElementById('msgInput');  // caja de texto

  let lastId='', unread=0; // para evitar duplicados y llevar el contador

  /* WEBSOCKET: llegada de mensajes ----------------------------- */
  ws.onmessage = evt=>{
    // el backend envía {payload:"texto", source:"Node-ABC123", topic:"..."}
    const {payload, source='?'} = JSON.parse(evt.data);

    // evita insertar dos veces seguidas el mismo mensaje
    const id = source+'|'+payload;
    if(id===lastId) return; lastId=id;

    /* --- pintar la burbuja --- */
    const time = new Date().toLocaleTimeString().slice(0,5);
    const div  = document.createElement('div');
    div.className = 'message ' + (source===LOCAL_SOURCE?'sent':'received');
    div.innerHTML = `${source===LOCAL_SOURCE?'Yo':source}: ${payload}
                     <span class="time">${time}</span>`;
    msgsEl.appendChild(div);

    /* auto-scroll solo si el usuario estaba al final */
    const nearBottom = msgsEl.scrollHeight - msgsEl.scrollTop - msgsEl.clientHeight < 15;
    if(nearBottom){
      msgsEl.scrollTop = msgsEl.scrollHeight;
    }else{
      unread++; badgeEl.textContent=unread; badgeEl.classList.remove('hidden');
    }
  };

  /* FORMULARIO: envío de mensaje ------------------------------- */
  formEl.addEventListener('submit',async e=>{
    e.preventDefault();
    const txt = inputEl.value.trim();      // texto limpio
    if(!txt) return;                       // no enviar si está vacío

    // POST al backend que publicará en MQTT
    await fetch('/publish',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:txt})
    });
    inputEl.value='';                      // limpia la caja
  });

  /* Limpiar badge al hacer scroll hasta abajo ------------------ */
  msgsEl.addEventListener('scroll',()=>{
    if(msgsEl.scrollHeight - msgsEl.scrollTop - msgsEl.clientHeight < 15){
      unread=0; badgeEl.classList.add('hidden');
    }
  });

});
</script>
</body>
</html>
